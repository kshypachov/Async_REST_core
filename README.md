# Асинхронний REST-сервіс з підтримкою системи «Трембіта»

REST-сервіс, описаний в даній інструкції, розроблений мовою програмування Python з використанням фреймворку FastAPI і є сумісним з системою «Трембіта».

FastAPI – це сучасний, швидкий (високопродуктивний) web-фреймворк для побудови API з Python 3.10+ на основі стандартних асинхронних викликів.

Даний сервіс передбачає отримання з бази даних (реєстру) відомостей про інформаційні об'єкти (користувачів) та управління їх статусом, у тому числі обробку запитів на пошук, отримання, створення, редагування та видалення об'єктів.


## Вимоги до програмного забезпечення 
| ПЗ            |   Версія   | Примітка                                                                                                                                                                                               |
|:--------------|:----------:|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Ubuntu Server |   24.04    | Рекомендовані характеристики віртуальної машини:<br/> CPU: 1 <br/> RAM: 512 Мб                                                                                                                         |
| Python        | **3.10!**  | За допомогою скрипта встановлюється автоматично.<br/> Також можна встановити вручну при виборі відповідного типу інсталяції.<br/>**Важливо!** Якщо версія Python нижче 3.10, сервіс працювати не буде. |
| MariaDB       |   10.5+    | За допомогою скрипта встановлюється автоматично.<br/> Також можна встановити вручну при виборі відповідного типу інсталяції                                                                            |
| Git           |            | Для клонування репозиторію                                                                                                                                                                             |


## Залежності

Залежності програмного забезпечення вебсервісу зазначені в файлі `requirements.txt`.

## Структура проєкту

Структура проєкту виглядає наступним чином:

```
Async_REST_core/
├── Dockerfile                 # Інструкції для створення Docker-образу
├── README.md                  # Документація по проєкту
├── alembic/
│   ├── env.py                 # Налаштування для міграцій БД з Alembic
│   ├── script.py.mako         # Шаблон для автоматично згенерованих міграцій
│   └── versions/              # Папка з версіями міграцій
├── alembic.ini                # Конфігурація для Alembic
├── compose.yaml               # Конфігурація для Docker Compose
├── config/
│   └── config.py              # Завантаження та обробка конфігураційних налаштувань
├── config.ini                 # Файл конфігурації проєкту
├── constants/
│   └── constants.py           # Константи, що використовуються у проєкті
├── database/
│   └── database.py            # Підключення до БД та сесії SQLAlchemy
├── deploy.sh                  # Скрипт для автоматизації встановлення проєкту
├── docs/                      # Документація по встановленню та використанню
│   ├── configuration.md       # Налаштування конфігурацій
│   ├── delete.md              # Інструкція по видаленню сервісу
│   ├── docker_installation.md # Встановлення за допомогою Docker
│   ├── https_nginx_reverse_proxy.md # Налаштування HTTPS через NGINX
│   ├── manual_installation.md # Ручне встановлення
│   ├── rest.sql               # SQL-скрипти для БД
│   ├── script_installation.md # Встановлення за допомогою скриптів
│   └── using.md               # Як користуватись сервісом
├── models/
│   └── models.py              # SQLAlchemy моделі БД
├── remove.sh                  # Скрипт для видалення сервісу
├── requirements.txt           # Залежності проєкту
├── routers/
│   ├── external.py            # Роутери для зовнішніх API
│   └── internal.py            # Роутери для внутрішніх API
├── run.py                     # Точка входу застосунку
└── schemas/
    └── schemas.py             # Pydantic-схеми для валідації даних
```

## Інсталяція сервісу

Сервіс можна інсталювати за допомогою скрипта автоматичного встановлення або вручну. Також сервіс може працювати в Docker 
- [Інсталяція сервісу за допомогою скрипта автоматичного встановлення](./docs/script_installation.md).
- [Інсталяція сервісу вручну](./docs/manual_installation.md).
- [Конфігурація сервісу](./docs/configuration.md).
- [Розгортання вебсервісу в Docker ](./docs/docker_installation.md).


## Наповнення бази даних тестовими записами

Для генерування запитів можна використовувати API чи перейти за посиланнями http://ip-адреса сервісу/docs та за допомогою Swagger, згенерувати запит до сервісу.

## Адміністрування сервісу

### Запуск вебсервісу

Для запуска вебсервісу необхідно виконати наступну команду:

```bash
sudo systemctl start async_rest_trembita
```

### Ознайомлення з документацією АРІ

Після запуску вебсервісу можна отримати доступ до автоматичної **документації API** за наступними адресами:

- Swagger UI: http://[адреса серверу]:8000/docs
- ReDoc: http://[адреса серверу]:8000/redoc

### Перевірка статусу вебсервісу

```bash
sudo systemctl status async_rest_trembita
```

### Зупинка вебсервісу

```bash
sudo systemctl stop async_rest_trembita
```

### Видалення вебсервісу

Для видалення вебсервісу та всіх пов'язаних компонентів було створено скрипт `remove.sh`.
Даний скрипт після запуску, зупинить та видалить вебсервіс, видалить віртуальне середовище, клонований репозиторій та системні залежності.

Для того, щоб запустити скрипт необхідно:

1. Зробити файл виконуваним:

```bash
chmod +x remove.sh
```

2. Запустити скрипт:

```bash
./remove.sh
```

Також існує можливість видалення вебсервісу вручну, згідно відповідної [інструкції](/docs/delete.md)

### Перегляд журналу подій

За замовчуванням журнал подій зберігається у файлі `async_rest_trembita.log`.

Конфігурація параметрів журналювання подій виконується в файлі «config.ini». Детальніше з параметрами журналювання в даному файлі можна ознайомитися в [настановах з конфігурації](/docs/configuration.md).

Для того, щоб переглянути журнал подій вебсервісу необхідно виконати команду:

```bash
journalctl -u async_rest_trembita -f
```

### Налаштування HTTPS

Налаштування підключення до сервісу за протоколом HTTPS наведено [в інструкції](./docs/https_nginx_reverse_proxy.md).

## Інтеграція вебсервісу з системою «Трембіта»

Системи «Трембіта» не вимагає особливої спеціалізації вебсервісів для роботи з нею. Для повноцінної інтеграції з системою «Трембіта» вебсервіс повинен підтримувати можливість зберігання заголовків системи «Трембіта», які було передані в запиті від вебкліента через ШБО.
В даному вебсервісі за це відповідає наступний фрагмент коду в файлі `run.py`, цей код перехоплює усі запити що надходять до сервісу та логує заголовки:

```
@app.middleware("http")
async def log_request_headers(request: Request, call_next):
    headers = dict(request.headers)
    logger.info("Заголовки запиту:")
    for header_key, header_value in headers.items():
        logger.info(f"    {header_key}: {header_value}")

    # Отримання query параметрів
    query_params = request.query_params
    query_id = query_params.get("queryId")
    user_id = query_params.get("userId")

    if query_id:
        logger.info(f"Значення параметру запиту queryId: {query_id}")
    if user_id:
        logger.info(f"Значення параметру запиту userId: {user_id}")

    response = await call_next(request)
    return response
```

де:
- header_key – заголовок запиту системи «Трембіта»;
- header_value – значення заголовку.

Більш детальну інформацію про заголовки наведено в описі [роботи із REST-сервісами в системі «Трембіта»](https://github.com/MadCat-88/Services-development-for-Trembita-system/blob/main/REST%20services%20development%20for%20Trembita%20system.md#%D0%B7%D0%B0%D0%B3%D0%BE%D0%BB%D0%BE%D0%B2%D0%BA%D0%B8-%D0%B7%D0%B0%D0%BF%D0%B8%D1%82%D1%96%D0%B2-%D0%B4%D0%BB%D1%8F-rest-%D1%81%D0%B5%D1%80%D0%B2%D1%96%D1%81%D1%96%D0%B2-%D0%BD%D0%B5%D0%BE%D0%B1%D1%85%D1%96%D0%B4%D0%BD%D1%96-%D0%B7%D0%B0%D0%B4%D0%BB%D1%8F-%D0%B7%D0%B0%D0%B1%D0%B5%D0%B7%D0%BF%D0%B5%D1%87%D0%B5%D0%BD%D0%BD%D1%8F-%D1%81%D1%83%D0%BC%D1%96%D1%81%D0%BD%D0%BE%D1%81%D1%82%D1%96-%D0%B7-%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%BE%D1%8E-%D1%82%D1%80%D0%B5%D0%BC%D0%B1%D1%96%D1%82%D0%B0).
- queryId та userId – додаткові параметри запиту, які передаються в URL.

- Більш детальну інформацію про додаткові параметри наведено в розділі [Використання сервісу](./docs/using.md).

## Використання сервісу

Вебсервіс представляє собою набір з 6 методів, які дозволяють управляти запитами інформації (requests) та записами про умовних користувачів (person) в БД. Методи веб сервісу поділено на 2 умовні категорії, зовнішні та внутрішні методи. Зовнішня частина слугує для створення запитів та отримання інформації за конкретним запитом, внутрішня частина слугує для опрацювання запитів створених за допомогою зовнішньої частини:
#### Зовнішня частина:
- [створення нового запиту](./docs/using.md#person-post);
- [отримання статусу запиту]()
- [отримання опрацьованного результату запиту](./docs/using.md#person-get-all);
- 
#### Внутрішня частина:

- [отримання всіх запитів](./docs/using.md#person-update);
- [встановлення статусу та коментара до запиту](./docs/using.md#person-get-by-parameter);
- [опрацювання запиту](././docs/using.md#person-delete).

Після встановлення вебсервісу його база даних порожня. 
Для демонстрації можливостей вебсервісу першим кроком необхідно створити нові записи в БД. Це можна зробити за допомогою Swagger, додавши новий запит у секції "/external/request/"

## Внесок

Якщо ви хочете зробити свій внесок у проєкт, будь ласка, створіть форк репозиторію і відправте Pull Request.

## Ліцензія

Цей проєкт ліцензується відповідно до умов MIT License.

 ##
Матеріали створено за підтримки проєкту міжнародної технічної допомоги «Підтримка ЄС цифрової трансформації України (DT4UA)».
