# Розгортання вебсрвісу в Docker

## Вимоги

| ПЗ             |   Версія   | Примітка                     |
|:---------------|:----------:|------------------------------|
| MariaDB        | **10.5+**  |                              |
| Docker         | **20.10+** |                              |
| Docker Compose |   10.5+    | Якщо планується використання |
| Git            |            | Для клонування репозиторію   |

## Змінні оточення

Вебсервіс підтримує конфігурацію через змінні оточення. 

Нижче наведено основні параметри:

- `USE_ENV_CONFIG`: Керує використанням змінних оточення для конфігурації. Якщо встановлено значення `true`, вебсервіс використовує змінні оточення замість конфігураційного файлу.
- `DB_USER`: Ім'я користувача бази даних.
- `DB_PASSWORD`: Пароль для підключення до бази даних.
- `DB_HOST`: Адреса хоста бази даних.
- `DB_NAME`: Ім'я бази даних.
- `LOG_FILENAME`: Ім'я файлу для логування. Якщо значення параметра порожне, логи будуть виводитися в консоль (stdout).
- `LOG_LEVEL`: Рівень логування (наприклад, `info`, `debug`).
- `LOG_FILEMODE`: Режим роботи з логами (наприклад, `a` — додавання до існуючого файлу або `w` — перезапис).

## Збір Docker-образу

Для того, щоб зібрати Docker-образ, необхідно:
1. Клонувати репозиторій:
```bash
wget https://raw.githubusercontent.com/kshypachov/FastAPI_trembita_service/master/deploy.sh
```
2. Перейти до директорії з вебсервісом:
```bash
cd FastAPI_trembita_service
```
3. Виконати наступну команду в кореневій директорії проєкту:
```bash
sudo docker build -t my-fastapi-app .
```

Дана команда створить Docker-образ з іменем `my-fastapi-app`, використовуючи Dockerfile, який знаходиться в поточній директорії.

## Створення бази даних для сервісу
Хоча контейнер і має у своєму складі компонент alembic котрий може створювати структуру бази даних, але його запуск з контейнера не є зручним.
Саме тому пропонується створити базу даних та її структуру вручну.

Для створення бази даних та її структури необхідно:
1. Встановити СУБД MariaDB згідно настанов пунктів 2-5 [настанов з ручного встановлення вебсервісу](./manual_installation.md#2-додати-репозиторій-mariadb).

2. Створити базу даних та користувача настанов пункту 6 [настанов з ручного встановлення вебсервісу](./manual_installation.md#6-створити-базу-даних-та-користувача-для-цього-необхідно).

3. Створити структуру таблиці за допомогою виконання наступної команди:

```bash
sudo mysql -e "USE your_db_name; CREATE TABLE IF NOT EXISTS \`person\` (
  \`id\` int(11) NOT NULL AUTO_INCREMENT,
  \`name\` varchar(128) NOT NULL,
  \`surname\` varchar(128) NOT NULL,
  \`patronym\` varchar(128) DEFAULT NULL,
  \`dateOfBirth\` date NOT NULL,
  \`gender\` enum('male','female') NOT NULL,
  \`rnokpp\` varchar(128) NOT NULL,
  \`passportNumber\` varchar(128) NOT NULL,
  \`unzr\` varchar(128) NOT NULL,
  PRIMARY KEY (\`id\`),
  UNIQUE KEY \`passportNumber\` (\`passportNumber\`),
  UNIQUE KEY \`unzr\` (\`unzr\`),
  UNIQUE KEY \`ix_person_rnokpp\` (\`rnokpp\`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;
COMMIT;"
```
де: `your_db_name` – назва БД, яка створена на попередньому кроці. 

## Запуск та використання контейнера зі змінними оточення

Щоб запустити контейнер з вебсервісом, необхідно виконати наступну команду:

```bash
sudo docker run -it --rm -p 8000:8000 \
    -e USE_ENV_CONFIG=true \
    -e DB_USER=myuser \
    -e DB_PASSWORD=mypassword \
    -e DB_HOST=mydbhost \
    -e DB_NAME=mydatabase \
    -e LOG_LEVEL=info \
    -e LOG_FILENAME="" \
    my-fastapi-app
```
де:
- параметр `-p 8000:8000` перенаправляє порт 8000 на локальній машині на порт 8000 всередині контейнера.
- `DB_USER`: Ім'я користувача бази даних.
- `DB_PASSWORD`: Пароль для підключення до бази даних.
- `DB_HOST`: Адреса хоста бази даних.
- `DB_NAME`: Назва бази даних.
- Змінна `LOG_FILENAME=""` задає виведення логів у консоль (stdout).

**Примітка:** У випадку розташування бази даних на одному хості з вебсервісом в значенні параметра `DB_HOST` необхідно вказувати IP-адресу хоста, значення `localhost` або `127.0.0.1` працювати не будуть. Окрім цього необхідно налаштувати зовнішні підключення до бази даних

Якщо планується повністю використовувати змінні оточення для конфігурації, необхідно переконатись, що `USE_ENV_CONFIG=true`. 

Наприклад:
```bash
sudo docker run -it --rm -p 8000:8000 \
    -e USE_ENV_CONFIG=true \
    -e DB_USER=myuser \
    -e DB_PASSWORD=mypassword \
    -e DB_HOST=mydbhost \
    -e DB_NAME=mydatabase \
    -e LOG_LEVEL=debug \
    my-fastapi-app
```

## Запуск та використання контейнера з конфігураційним файлом

Контейнер з вебсервісом можна запустити використовуючи конфігураційний файл замість змінних оточення. 
Для цього необхідно створити файл `config.ini` в директорії вебсервіса та вказати шлях до нього

```bash
sudo docker run -it --rm -p 8000:8000 \
    -v $(pwd)/config.ini:/app/config.ini \
    my-fastapi-app
```

де параметр `-v $(pwd)/config.ini:/app/config.ini` монтує локальний файл конфігурації в контейнер за шляхом `/app/config.ini`.

 **Приклад конфігураційного файлу `config.ini`:**

```ini
[database]
db_type = mysql
username = myuser
password = mypassword
host = mydbhost
name = mydatabase

[logging]
filename = /var/log/app.log
filemode = a
format = %(asctime)s - %(name)s - %(levelname)s - %(message)s
dateformat = %Y-%m-%d %H:%M:%S
level = info
```

Якщо змінна оточення `USE_ENV_CONFIG` не задана або встановлене значення `false`, вебсервіс буде використовувати конфігураційний файл для налаштування. Необхідно переконатись, що файл доступний у контейнері, як показано в даному розділі вище.

## Перегляд журналів подій

Якщо виведення журналів подій налаштоване у консоль, переглядати їх можна за допомогою команди:

```bash
docker logs <container_id>
```

В разі, якщо журнали подій зберігаються у файл (через змінну оточення `LOG_FILENAME` або конфігураційний файл), можна налаштувати монтування директорії з журналами подій на локальній машині наступним чином:

```bash
docker run -it --rm -p 8000:8000 \
    -e LOG_FILENAME="/var/log/app.log" \
    -v $(pwd)/logs:/var/log \
    my-fastapi-app
```

де параметр `-v $(pwd)/logs:/var/log` монтує локальну директорію для збереження журналів подій.

##
Матеріали створено за підтримки проєкту міжнародної технічної допомоги «Підтримка ЄС цифрової трансформації України (DT4UA)».
